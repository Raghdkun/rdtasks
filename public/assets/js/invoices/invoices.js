$(document).ready((function(){"use strict";$("#clientSelectBox,#discountTypeSelect").select2({width:"100%"}),$(".projects-select-box").select2({width:"100%"}),$(".task-select-box").select2({width:"100%"}),$(".tax-select-box").select2({width:canManageTax?"calc(100% - 44px)":"100%"}),$("#filter_status,#due_date_filter").select2(),$(".issue-datepicker").datetimepicker({format:"YYYY-MM-DD",useCurrent:!1,locale:"ar"==languageName?"en":languageName,icons:{previous:"icon-arrow-left icons",next:"icon-arrow-right icons"},sideBySide:!0,maxDate:new Date,widgetPositioning:{horizontal:"left",vertical:"bottom"}}),$(".due-datepicker").datetimepicker({format:"YYYY-MM-DD",useCurrent:!1,locale:"ar"==languageName?"en":languageName,icons:{previous:"icon-arrow-left icons",next:"icon-arrow-right icons"},sideBySide:!0,minDate:moment().subtract(1,"days"),widgetPositioning:{horizontal:"left",vertical:"bottom"}}),$(".issue-datepicker, .due-datepicker").on("dp.show",(function(){matchWindowScreenPixels({issueDate:".issue-datepicker",dueDate:".due-datepicker"},"inv")})),$(window).resize((function(){matchWindowScreenPixels({issueDate:".issue-datepicker",dueDate:".due-datepicker"},"inv")})).trigger("resize"),$("#invoiceNumber").attr("readonly",!0),$("#clientSelectBox,.projects-select-box").prop("disabled",!0);var e,t=0,a=0,i=0,n=$("#fixRateAmount").val();if(invoiceEdit){var o=$("#netTotal").text(),r=$("#subTotal").text();c(),$("#netTotal").text(currency(o).format()),$("#subTotal").text(currency(r).format())}function s(e){0==e&&(e=$("#discount").val("0"),$("#discount").prop("readonly",!0))}function c(){a=0,$(".items-container>tr").each((function(){var e=$(this).find(".task-amount").val();a+=parseFloat(removeCommas(e)),a=parseFloat(a)})),a+=parseFloat(n),$("#subTotal").text(getFormattedPrice(a))}function l(n){var o=0;o=1==e?(parseFloat(a)-i)*t/100:removeCommas(n)*t/100,$("#taxAmount").text(currency(o).format())}isCreate&&(c(),$("#subTotal").text(currency(a).format()),$("#netTotal").text(currency(a).format())),$(document).on("change","#clientSelectBox",(function(){$(".projects-select-box").children(".new-option").remove(),$(".projects-select-box").val("").trigger("change");var e=$(this).val();""!==e&&$.ajax({url:route("get.client-projects",e),type:"GET",success:function(e){$.each(e.data,(function(e,t){var a=prepareTemplateRender("#optionsTemplate",[{value:e,label:t}]);$(".projects-select-box").append(a),$(".projects-select-box").select2({width:"100%"})}))}})})),$(document).on("change",".projects-select-box",(function(){$(".task-select-box").children(".new-option").remove(),$(".task-select-box").val("").trigger("change");var e=$(this).val();$.ajax({url:route("get.project-tasks",e),type:"get",success:function(e){$.each(e.data,(function(e,t){var a=prepareTemplateRender("#optionsTemplate",[{value:e,label:t}]);$(".task-select-box").append(a),$(".task-select-box").select2({width:"100%"})}))}})})),invoiceEdit&&s(e=$("#discountTypeSelect").val()),$(document).on("change","#discountTypeSelect",(function(){$("#discount").prop("readonly",!1),s(e=$("#discountTypeSelect").val()),l($("#subTotal").text()),d()})),$(document).on("change",".tax-select-box",(function(){t=0,""!==$(this).val()&&(t=taxRatesArr[$(this).val()]),$("#invoiceTax").text(t),l($("#subTotal").text()),d()})),$(document).on("change",".task-select-box",(function(){var e=$(this).val();""!==e&&$.ajax({url:route("get.task-details",e),type:"get",success:function(e){var t=$(".items-container").find("tr:last-child");""!==t.find(".item-name").val()&&($("#itemAddBtn").trigger("click"),t=$(".items-container").find("tr:last-child")),t.find(".task-id").val(e.data.id),t.find(".item-name").val(e.data.title),t.find(".hours").val(e.data.duration),isEmpty(e.data.description)?t.find(".item-description").val("N/A"):t.find(".item-description").val(e.data.description)}})})),$(document).on("click","#itemAddBtn",(function(e){e.preventDefault();var t=[{currencyClass:currentCurrency}],a=prepareTemplateRender("#invoiceItemTemplate",t);$(".items-container").append(a)})),$(document).on("click",".remove-invoice-item",(function(e){e.preventDefault(),$(this).parent().parent().remove(),c(),l($("#subTotal").text()),d()})),$(document).on("keyup",".hours",(function(){/^\d{0,4}(\.\d{0,2})?$/.test($(this).val())||$(this).val(0),c(),l($("#subTotal").text()),d()})),$(document).on("keyup",".task-amount",(function(){$(this).val($(this).val().replace(/[^0-9.]/g,"").replace(/(\..*)\./g,"$1"));var e=removeCommas($(this).val());""!=$(this).val()?$(this).val(e):$(this).val(0),c(),l($("#subTotal").text()),d()})),$(document).on("keyup","#discount",(function(){return isEmpty(e)?($(this).val(""),displayErrorMessage("Select Discount Apply."),!1):(i=$(this).val().replace(/,/g,"").replace(/[^0-9.]/g,"").replace(/(\..*)\./g,"$1"),$(this).val(currency(i,{precision:0}).format()),l($("#subTotal").text()),d(),parseFloat($("#netTotal").text())<0?(displayErrorMessage("Total amount should be greater than 0."),!1):void 0)}));var d=function(){if(1==e){var n=parseFloat(a)-i,o=(n+parseFloat(n*t/100)).toFixed(2);$(document).find("#netTotal").text(currency(o).format())}else if(2==e){var r=a*t/100,s=(parseFloat(a)+parseFloat(r)).toFixed(2)-i;$(document).find("#netTotal").text(currency(s).format())}else{var c=a*t/100;i=0;var l=(parseFloat(a)+parseFloat(c)).toFixed(2)-i;$(document).find("#netTotal").text(currency(l).format())}};$(document).on("click","#saveAsDraft, #saveAndSend",(function(e){if(parseFloat($("#netTotal").text())<0)return displayErrorMessage("Total amount should be greater than 0."),!1;e.preventDefault(),screenLock();var t=$(this).data("status"),i=document.getElementById("invoiceForm");if($("#invoiceForm").validate({errorPlacement:function(e,t){}}).settings.ignore=":disabled,:hidden",!$("#invoiceForm").valid())return screenUnLock(),!1;$("#clientSelectBox,.projects-select-box").prop("disabled",!1);var n=new FormData(i);n.append("invoice_status",t),n.append("report_id",$("#reportId").val());var o,r,s,c,l,d,u,p,m=0;if(l=$("#netTotal").text(),d=$("#totalHour").text(),$(".items-container>tr").each((function(){o=$(this).find(".item-name").val(),r="",null!=$(this).find(".task-id").val()&&(r=$(this).find(".task-id").val()),null!=$(this).find(".item_project_id").val()&&(u=$(this).find(".item_project_id").val()),null!=$(this).find(".fix_rate").val()&&(p=$(this).find(".fix_rate").val()),s=$(this).find(".hours").val(),c=$(this).find(".task-amount").val(),n.append("itemsArr["+m+"][item_name]",o),n.append("itemsArr["+m+"][task_id]",r),n.append("itemsArr["+m+"][item_project_id]",u),n.append("itemsArr["+m+"][fix_rate]",p),n.append("itemsArr["+m+"][hours]",s),n.append("itemsArr["+m+"][task_amount]",c),m++})),isEmpty(o)||isEmpty(s)||"0"==s)return displayErrorMessage("Please fill all the required fields."),$("#clientSelectBox,.projects-select-box").prop("disabled",!0),screenUnLock(),!1;n.append("amount",l),n.append("sub_total",a),n.append("total_hour",d),$.ajax({url:route("invoices.store"),type:"POST",data:n,processData:!1,contentType:!1,success:function(e){e.success&&(window.location.href=invoicesUrl+"/"+e.data.id)},error:function(e){screenUnLock(),$("#clientSelectBox,.projects-select-box").prop("disabled",!0),manageAjaxErrors(e,"validationErrorsBox")}})})),$(document).on("click","#editSaveAsDraft, #editSaveAndSend",(function(e){if(parseFloat($("#netTotal").text())<0)return displayErrorMessage("Total amount should be greater than 0."),!1;e.preventDefault(),screenLock();var t=$(this).data("status"),i=document.getElementById("editInvoiceForm");if($("#editInvoiceForm").validate({errorPlacement:function(e,t){}}).settings.ignore=":disabled,:hidden",!$("#editInvoiceForm").valid())return screenUnLock(),!1;$("#clientSelectBox,.projects-select-box").prop("disabled",!1);var n=$("#hdnInvoiceId").val(),o=new FormData(i);o.append("invoice_status",t);var r,s,c,l,d,u,p,m,v=0;if(d=$("#netTotal").text(),u=$("#totalHour").text(),$(".items-container>tr").each((function(){r=$(this).find(".item-name").val(),s="",null!=$(this).find(".task-id").val()&&(s=$(this).find(".task-id").val()),null!=$(this).find(".item_project_id").val()&&(p=$(this).find(".item_project_id").val()),null!=$(this).find(".fix_rate").val()&&(m=$(this).find(".fix_rate").val()),c=$(this).find(".hours").val(),l=$(this).find(".task-amount").val(),o.append("itemsArr["+v+"][item_name]",r),o.append("itemsArr["+v+"][task_id]",s),o.append("itemsArr["+v+"][item_project_id]",p),o.append("itemsArr["+v+"][fix_rate]",m),o.append("itemsArr["+v+"][hours]",c),o.append("itemsArr["+v+"][task_amount]",l),v++})),isEmpty(r)||isEmpty(c)||"0"==c)return displayErrorMessage("Please fill all the required fields."),$("#clientSelectBox,.projects-select-box").prop("disabled",!0),screenUnLock(),!1;o.append("amount",d),o.append("sub_total",a),o.append("total_hour",u);var f=jQuery(this);f.button("loading"),$.ajax({url:invoicesUrl+"/"+n,type:"POST",data:o,processData:!1,contentType:!1,success:function(e){e.success&&(userIsClient||(window.location.href=invoicesUrl+"/"+e.data.id))},error:function(e){screenUnLock(),$("#clientSelectBox,.projects-select-box").prop("disabled",!0),manageAjaxErrors(e,"validationErrorsBox")},complete:function(){f.button("reset")}})})),"undefined"!=typeof invoiceEdit&&invoiceEdit&&($(".projects-select-box, .tax-select-box").trigger("change"),$("#discount").trigger("keyup")),$(document).on("click",".delete-btn",(function(e){var t=$(e.currentTarget).attr("data-id");deleteItem(route("invoices.destroy",t),"tableName","Invoice","location.reload()")})),$(document).on("change","#filter_status",(function(){window.livewire.emit("filterTasksByStatus",$(this).val())})),$(document).on("change","#due_date_filter",(function(){window.livewire.emit("filterDueDate",$(this).val())})),$(document).on("submit","#addNewForm",(function(e){e.preventDefault();var t=jQuery(this).find("#btnSave");t.button("loading"),$.ajax({url:"/taxes",type:"POST",data:$(this).serialize(),success:function(e){if($("#taxId, #editTaxId").empty(),e.success){displaySuccessMessage(e.message);var t="<option value=''>Select Tax</option>";$.each(e.data.taxes,(function(e,a){t+="<option value='"+a+"'>"+e+"</option>",$("#taxId, #editTaxId").html(t)})),window.taxRatesArr=[],taxRatesArr=e.data.taxesArr,$("#taxId").val(e.data.tax.id).trigger("change"),$("#editTaxId").val(e.data.tax.id).trigger("change"),$("#AddModal").modal("hide")}},error:function(e){printErrorMessage("#taxValidationErrorsBox",e)},complete:function(){t.button("reset")}})})),$("#AddModal").on("hidden.bs.modal",(function(){resetModalForm("#addNewForm","#taxValidationErrorsBox")}))}));